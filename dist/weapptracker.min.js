!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):e.xbosstrack=t()}(this,function(){var e=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},t=function(){function e(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(t,n,r){return n&&e(t.prototype,n),r&&e(t,r),t}}(),n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},r=App,o=Page,a=Component,i=function(){function n(t){var i=this;e(this,n),this.injectPageMethods=[],this.injectAppMethods=[],this.extraPageMethods=[],this.extraAppMethods=[],this.injectComponentMethods=[],this.extraComponentMethods=[],t||(App=function(e){return r(i._create(e,i.injectAppMethods,i.extraAppMethods))},Page=function(e){return o(i._create(e,i.injectPageMethods,i.extraPageMethods))},Component=function(e){return a(i._createComponent(e,i.injectComponentMethods,i.extraComponentMethods))})}return t(n,[{key:"_wrapTargetMethod",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[],o=e[n];e[n]=function(){for(var a=this,i=arguments.length,c=Array(i),u=0;u<i;u++)c[u]=arguments[u];var h=o&&o.apply(this,c),s=function(){r.forEach(function(r){r.apply(a,[e,t,n].concat(c))})};try{"[object Promise]"===Object.prototype.toString.call(h)?h.then(function(){s()}).catch(function(){s()}):s()}catch(e){console.error(n,"钩子函数执行出现错误",e)}return h}}},{key:"_addExtraMethod",value:function(e,t){t.forEach(function(t){var n=t.customName||t.name;e[n]=t})}},{key:"_create",value:function(e,t,n){var r=this;return Object.keys(e).filter(function(t){return"function"==typeof e[t]}).forEach(function(n){r._wrapTargetMethod(e,null,n,t)}),this._addExtraMethod(e,n),e}},{key:"_createComponent",value:function(e,t,n){var r=this,o=e.methods||{};return Object.keys(o).filter(function(e){return"function"==typeof o[e]}).forEach(function(n){r._wrapTargetMethod(o,e,n,t)}),this._addExtraMethod(o,n),e}},{key:"addPageMethodWrapper",value:function(e){this.injectPageMethods.push(e)}},{key:"addComponentMethodWrapper",value:function(e){this.injectComponentMethods.push(e)}},{key:"addAppMethodWrapper",value:function(e){this.injectAppMethods.push(e)}},{key:"addPageMethodExtra",value:function(e){this.extraPageMethods.push(e)}},{key:"addAppMethodExtra",value:function(e){this.extraAppMethods.push(e)}},{key:"createApp",value:function(e){r(this._create(e,this.injectAppMethods,this.extraAppMethods))}},{key:"createPage",value:function(e){o(this._create(e,this.injectPageMethods,this.extraPageMethods))}},{key:"createComponent",value:function(e){o(this._createComponent(e,this.injectPageMethods,this.extraPageMethods))}}]),n}(),c=function(){var e=getCurrentPages();return e.length?e[e.length-1]:{}},u=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments[2],r=t.index,o=e.split("."),a=n;return o.length>-1?o.forEach(function(e){var t=function(e,t){var n=e.indexOf("["),r=e.indexOf("]"),o={};if(n>-1){var a=e.substring(n+1,r),i=e.substring(0,n);"$INDEX"===a&&(a=t),o.key=i,o.index=parseInt(a,10)}return o}(e,r);a=t.key&&a[t.key]?a[t.key][t.index]:a[e]}):a=n[e],a},h=function(e,t,n,r){try{return 0===e.indexOf("$")?function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},r="";e.indexOf("$APP.")>-1?r=getApp()[e.split("$APP.")[1]]:e.indexOf("$DATASET.")>-1?r=t[e.split("$DATASET.")[1]]:e.indexOf("$INDEX")>-1?r=t.index:e.indexOf("$ARG")>-1&&(r=n[e.split("$ARG.")[1]]);return r}(e,t,r):u(e,t,n)}catch(e){return console.log(e),""}};return function(r){function o(t){var r=t.tracks,a=t.onTrackEvent,i=void 0===a?function(){}:a,c=t.isUsingPlugin,u=t.watchRouteChange,h=t.asyncReg,s=void 0!==h&&h;e(this,o);var f=n(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,c));return f.tracks=s?[]:r,f.onTrackEvent=i,f.addPageMethodExtra(f.elementTracker()),f.addPageMethodWrapper(f.methodTracker()),f.addComponentMethodWrapper(f.comMethodTracker()),u&&f.regRouteChangeWatcher(),f}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(o,i),t(o,[{key:"regConfig",value:function(e){this.tracks=e}},{key:"regRouteChangeWatcher",value:function(){var e=this;wx.onAppRoute(function(t){var n=[];Object.keys(t).forEach(function(e){n.push({name:e,data:t[e]})});var r={evtName:"route_change",report:n};e.onTrackEvent(r)})}},{key:"elementTracker",value:function(){var e=this,t=function(t){var n=e.findActivePageTracks("element"),r=c().data;n.forEach(function(n){var o;(o=n.element,new Promise(function(e){var t=wx.createSelectorQuery();t.selectAll(o).boundingClientRect(),t.selectViewport().scrollOffset(),t.exec(function(t){return e({boundingClientRect:t[0],scrollOffset:t[1]})})})).then(function(o){o.boundingClientRect.forEach(function(a){var i=function(e,t,n){if(!t)return!1;var r=e.detail,o=r.x,a=r.y,i=t.left,c=t.right,u=t.top,h=t.height,s=n.scrollTop;return i<o&&o<c&&s+u<a&&a<s+u+h}(t,a,o.scrollOffset);n.dataset=a.dataset,i&&e.handleReport(n,r)})})})};return t.customName="elementTracker",t}},{key:"methodTracker",value:function(){var e=this;return function(t,n,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=e.findActivePageTracks("method"),i=c().data,u=(o.currentTarget||{}).dataset;a.forEach(function(t){t.method===r&&(t.dataset=u,t.args=o||[],e.handleReport(t,i))})}}},{key:"comMethodTracker",value:function(){var e=this;return function(t,n,r){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},a=e.findActivePageTracks("comMethod"),i=this.data,c=(o.currentTarget||{}).dataset;a.forEach(function(t){t.method===r&&(t.dataset=c,e.handleReport(t,i))})}}},{key:"findActivePageTracks",value:function(e){try{var t=c().route,n=this.tracks.find(function(e){return e.path===t})||{},r=[];return"method"===e?r=n.methodTracks||[]:"element"===e?r=n.elementTracks||[]:"comMethod"===e&&(r=n.comMethodTracks||[]),[].concat(function(e){if(Array.isArray(e)){for(var t=0,n=Array(e.length);t<e.length;t++)n[t]=e[t];return n}return Array.from(e)}(r))}catch(e){return{}}}},{key:"handleReport",value:function(e,t){var n={evtName:e.evtName||"",report:function(e,t){var n=e.element,r=e.method,o=[];return e.dataKeys.forEach(function(a){var i=h(a,e.dataset,t,e.args);o.push({element:n,method:r,name:a,data:i})}),console.log(e.args),console.table(o),o}(e,t)};this.onTrackEvent(n,e)}},{key:"emit",value:function(e,t){Array.isArray(t)||(t=[t]);var n={evtName:e||"",report:t};console.table(t),this.onTrackEvent(n)}}]),o}()});
